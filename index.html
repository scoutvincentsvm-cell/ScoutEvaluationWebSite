<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scout Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body{background:#F8FAFC}
    .navbar{background:#fff;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    .brand{color:#111827;font-weight:800;letter-spacing:.3px}
    .brand img{height:28px;width:auto;object-fit:contain}
    .card{border:0;box-shadow:0 8px 24px rgba(2,6,23,.06);border-radius:16px}
    .progress{height:10px;border-radius:10px}
    .app-loader{position:fixed;inset:0;background:rgba(255,255,255,.65);display:none;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(2px);font-weight:600}
    .fieldcard{transition:transform .15s ease,box-shadow .15s ease}
    .fieldcard:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(2,6,23,.10)}
    .badge-top{position:absolute;top:10px;inset-inline-end:10px;border-radius:999px;padding:.35rem .6rem}
    .badge-promote{background:#10B981;color:#fff;box-shadow:0 6px 14px rgba(16,185,129,.25)}
    .badge-featured{background:#22D3EE;color:#0c4a6e;box-shadow:0 6px 14px rgba(34,211,238,.25);inset-inline-end:116px}
    .rank-chip{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:600}
    .rank-1{background:#9CA3AF;color:#fff}
    .rank-2{background:#F59E0B;color:#111827}
    .rank-3{background:#3B82F6;color:#fff}
    .muted{color:#6B7280}
    canvas{max-height:260px}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-4">
  <div class="container">
    <a class="navbar-brand brand d-flex align-items-center gap-2" href="#">
      <img id="navLogo" alt="Logo" style="display:none">
      <span>Scout Manager</span>
    </a>
    <div class="ms-auto d-flex align-items-center">
      <span class="me-3 text-muted" id="whoami"></span>
      <button class="btn btn-outline-danger btn-sm" id="btnLogout" style="display:none;">خروج</button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- Login -->
  <section id="viewLogin" class="row justify-content-center">
    <div class="col-md-5">
      <div class="card p-4 text-center">
        <img id="siteLogo" alt="Logo" style="height:130px;object-fit:contain;margin-bottom:12px;display:none">
        <h5 class="mb-3">تسجيل الدخول</h5>
        <form id="loginForm" autocomplete="on">
          <div class="mb-3 text-start">
            <label class="form-label">اسم المستخدم</label>
            <input id="inUser" name="username" type="text" class="form-control" autocomplete="username" required>
          </div>
          <div class="mb-3 text-start">
            <label class="form-label">كلمة السر</label>
            <input id="inPass" name="password" type="password" class="form-control" autocomplete="current-password" required>
          </div>
          <button id="btnLogin" type="submit" class="btn btn-primary w-100">دخول</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Leader View -->
  <section id="viewLeader" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">أعضاء فريقي</h5>
      <div class="d-flex gap-2">
        <select id="leadRank" class="form-select" style="width:auto"><option value="">كل الرتب</option></select>
        <input id="leadQ" class="form-control" placeholder="ابحث بالاسم…">
      </div>
    </div>
    <div id="leaderMembers" class="row g-3"></div>
  </section>

  <!-- Admin View -->
  <section id="viewAdmin" style="display:none;">
    <div class="row g-3 mb-4">
      <div class="col-lg-7">
        <div class="card p-3">
          <h6>توزيع الأعضاء حسب الفريق</h6>
          <canvas id="chPerTeam" height="220"></canvas>
          <div class="small text-muted mt-2" id="teamAvgNote"></div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6 class="mb-2">عدد الأشخاص في كل رتبة (الحالي)</h6>
          <ul id="listPerRank" class="list-group list-group-flush small"></ul>
        </div>
        <div class="card p-3">
          <h6 class="mb-2">بعد تطبيق الترقيات الحالية</h6>
          <ul id="listPerRankAfter" class="list-group list-group-flush small"></ul>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2 mb-3">
        <div class="col-auto"><select id="fltTeam" class="form-select"><option value="">كل الفرق</option></select></div>
        <div class="col-auto"><select id="fltRank" class="form-select"><option value="">كل الرتب</option></select></div>
        <div class="col"><input id="fltQ" class="form-control" placeholder="بحث بالاسم…"></div>
        <div class="col-auto d-flex align-items-center gap-2">
          <div class="form-check"><input class="form-check-input" type="checkbox" id="fltPromoted"><label class="form-check-label" for="fltPromoted">تمت ترقيتهم (أغلبية)</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="fltFeatured"><label class="form-check-label" for="fltFeatured">حاصلون على تميّز (أغلبية)</label></div>
        </div>
      </div>
      <div id="adminMembers" class="row g-3"></div>
    </div>
  </section>

</div>

<!-- Member Modal -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="mmTitle" class="modal-title">عضو</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><div id="mmBody"></div></div>
      <div class="modal-footer" id="mmFooter"></div>
    </div>
  </div>
</div>

<!-- Loader -->
<div id="appLoader" class="app-loader">
  <div class="spinner-border" role="status" aria-hidden="true"></div>
  <span class="ms-2" id="appLoaderMsg">جارِ التحميل…</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  // === CONFIG ===
  const API = "https://script.google.com/macros/s/AKfycbwfXLy2WZyfBv9rT-ioK505wynnRm-x35eIjyC9H8QSEjHmGzipjoXjVpN7qU7nAWEK/exec";
  const DEFAULT_LOGO_URL = "../Scout.png";

  // Loader
  function showLoader(msg='جارِ التحميل…'){ document.getElementById('appLoaderMsg').textContent=msg; document.getElementById('appLoader').style.display='flex'; }
  function hideLoader(){ document.getElementById('appLoader').style.display='none'; }
async function withLoader(fn, msg){
  showLoader(msg || 'جارِ التحميل…');
  try {
    return await fn();
  } finally {
    hideLoader();
  }
}
  // API
  async function api(path, payload={}){ payload.path=path; const res=await fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)}); const data=await res.json(); if(!data.ok) throw new Error(data.error||'API error'); return data; }

  // State
  const STATE={token:null,user:null,ranks:[]}; let LOOKUPS={teams:[],ranks:[],logoUrl:''};
  function saveSession(t,u){ localStorage.setItem('SM_TOKEN',t); localStorage.setItem('SM_USER',JSON.stringify(u)); }
  function loadSession(){ const t=localStorage.getItem('SM_TOKEN'),u=localStorage.getItem('SM_USER'); if(t&&u){ STATE.token=t; STATE.user=JSON.parse(u); return true; } return false; }
  function clearSession(){ localStorage.removeItem('SM_TOKEN'); localStorage.removeItem('SM_USER'); STATE.token=null; STATE.user=null; }
  function showView(id){ ['viewLogin','viewLeader','viewAdmin'].forEach(s=>document.getElementById(s).style.display='none'); document.getElementById(id).style.display=''; document.getElementById('btnLogout').style.display=(id==='viewLogin')?'none':''; }

  // Lookups
  async function loadLookups(){ LOOKUPS = await api('getLookups', {}); STATE.ranks = LOOKUPS.ranks||[]; return LOOKUPS; }
  function setLogos(url){
    const site=document.getElementById('siteLogo'); const nav=document.getElementById('navLogo');
    if(url){ site.src=url; site.style.display='inline-block'; nav.src=url; nav.style.display='inline-block'; }
  }
  function teamNameById(id){ const t=(LOOKUPS.teams||[]).find(x=>x.id===id); return t? t.name : id; }
  function rankNameById(id){ const r=(LOOKUPS.ranks||[]).find(x=>x.id===id); return r? r.name : id; }
  function rankOrderById(id){ const r=(LOOKUPS.ranks||[]).find(x=>x.id===id); return r? (r.order||0) : 0; }
  function rankClassFromOrder(o){ if(o>=3) return 'rank-3'; if(o===2) return 'rank-2'; return 'rank-1'; }
  function debounce(fn,wait=100){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

  // On load: fetch logo BEFORE login
  document.addEventListener('DOMContentLoaded', async ()=>{
    try {
      const lk = await loadLookups(); // no auth needed
      setLogos(lk.logoUrl || DEFAULT_LOGO_URL);
    } catch(e) {
      setLogos(DEFAULT_LOGO_URL);
    }

    // login submit
    document.querySelector('#loginForm')?.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const username=document.querySelector('#inUser').value.trim();
      const password=document.querySelector('#inPass').value;
      try{
        const data = await withLoader(()=>api('login',{username,password}),'جارِ تسجيل الدخول…');
        STATE.token=data.token; STATE.user=data.user; saveSession(data.token,data.user);
        await initCommon();
        if (data.user.role==='ADMIN') initAdmin(); else initLeader();
      }catch(err){ alert(err.message); }
    });

    if (loadSession()) { await initCommon(); if (STATE.user.role==='ADMIN') initAdmin(); else initLeader(); }
    else { showView('viewLogin'); }
  });

  async function initCommon(){
    document.getElementById('whoami').textContent=`${STATE.user?.name||''} (${STATE.user?.role||''})`;
    // refresh lookups again (in case data changed)
    const lk = await loadLookups();
    setLogos(lk.logoUrl || DEFAULT_LOGO_URL);
  }

  document.getElementById('btnLogout').addEventListener('click',()=>{ clearSession(); document.getElementById('whoami').textContent=''; showView('viewLogin'); });

  // ===== Leader =====
  async function initLeader(){
    showView('viewLeader');
    const sel=document.getElementById('leadRank'); sel.innerHTML='<option value="">كل الرتب</option>';
    (LOOKUPS.ranks||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; sel.appendChild(o); });
    const deb=debounce(loadLeaderMembers,250);
    document.getElementById('leadRank').addEventListener('change',deb);
    document.getElementById('leadQ').addEventListener('input',deb);
    await loadLeaderMembers();
  }
  async function loadLeaderMembers(){
    const filters={ q:document.getElementById('leadQ').value||null, rankId:document.getElementById('leadRank').value||null };
    const res=await withLoader(()=>api('listMembers',{token:STATE.token,filters}),'جارِ تحميل الأعضاء…');
    const wrap=document.getElementById('leaderMembers'); wrap.innerHTML='';
    res.members.forEach(m=>{
      const col=document.createElement('div'); col.className='col-md-4';
      const rClass=rankClassFromOrder(m.rankOrder||rankOrderById(m.rankId));
      col.innerHTML=`<div class="card p-3 fieldcard position-relative">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-bold">${m.name}</div>
              <div class="small"><span class="rank-chip ${rClass}">${m.rankName}</span></div>
              <div class="text-muted small mt-1">الفريق: ${m.teamName}</div>
              <div class="small mt-2">الحضور: <strong>${m.attendance.attended}</strong> / ${m.attendance.total} — الغياب: <strong>${Math.max((m.attendance.total-m.attendance.attended),0)}</strong></div>
            </div>
          </div>
          <div class="mt-3"><div class="small text-muted mb-1">نسبة الحضور</div><div class="progress"><div class="progress-bar" style="width:${m.attendance.percent||0}%"></div></div></div>
          <div class="mt-2 small text-muted">آخر تقييم: ${m.lastEval.pctAvg?(m.lastEval.pctAvg+'%'):'-'}</div>
          <div class="mt-3"><button class="btn btn-sm btn-primary" data-open="${m.memberId}">تقييم / حضور</button></div>
        </div>`;
      wrap.appendChild(col);
    });
  }

  // ===== Admin =====
  let CH_TEAM=null;
  async function initAdmin(){
    showView('viewAdmin');
    const selT=document.getElementById('fltTeam'), selR=document.getElementById('fltRank');
    selT.innerHTML='<option value="">كل الفرق</option>'; selR.innerHTML='<option value="">كل الرتب</option>';
    (LOOKUPS.teams||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; selT.appendChild(o); });
    (LOOKUPS.ranks||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; selR.appendChild(o); });
    const deb=debounce(loadAdminMembers,250);
    selT.addEventListener('change',deb); selR.addEventListener('change',deb);
    document.getElementById('fltQ').addEventListener('input',deb);
    document.getElementById('fltPromoted').addEventListener('change',deb);
    document.getElementById('fltFeatured').addEventListener('change',deb);
    await loadAdminStats(); await loadAdminMembers();
  }
  async function loadAdminStats(){
    const s=await withLoader(()=>api('getStatsV2',{token:STATE.token}),'جارِ تحميل الإحصائيات…');
    const tLabels=Object.keys(s.perTeam).map(k=>s.teamMap[k]||k);
    const tData=Object.keys(s.perTeam).map(k=>s.perTeam[k]);
    if(CH_TEAM) CH_TEAM.destroy();
    CH_TEAM=new Chart(document.getElementById('chPerTeam'),{type:'bar',data:{labels:tLabels,datasets:[{label:'عدد الأعضاء',data:tData,borderRadius:8}]},options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>v,font:{weight:'bold'}}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}},plugins:[ChartDataLabels]});
    const L1=document.getElementById('listPerRank'); L1.innerHTML='';
    const L2=document.getElementById('listPerRankAfter'); L2.innerHTML='';
    Object.keys(s.perRank).forEach(k=>{const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between'; li.innerHTML=`<span>${s.rankMap[k]||k}</span><strong>${s.perRank[k]}</strong>`; L1.appendChild(li);});
    Object.keys(s.perRankAfter).forEach(k=>{const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between'; li.innerHTML=`<span>${s.rankMap[k]||k}</span><strong>${s.perRankAfter[k]}</strong>`; L2.appendChild(li);});
    const avg=Object.keys(s.attAvgTeam||{}).map(k=>`${s.teamMap[k]||k}: ${s.attAvgTeam[k]}%`).join(' • ');
    document.getElementById('teamAvgNote').textContent=avg?`متوسط الحضور: ${avg}`:'';
  }
  async function loadAdminMembers(){
    const filters={ teamId:document.getElementById('fltTeam').value||null, rankId:document.getElementById('fltRank').value||null, q:document.getElementById('fltQ').value||null, promoted:document.getElementById('fltPromoted').checked?'true':null, featured:document.getElementById('fltFeatured').checked?'true':null };
    const res=await withLoader(()=>api('getMembersAdmin',{token:STATE.token,filters}),'جارِ تحميل الأعضاء…');
    const grid=document.getElementById('adminMembers'); grid.innerHTML='';
    res.members.forEach(m=>{
      const col=document.createElement('div'); col.className='col-md-4';
      const rClass=rankClassFromOrder(m.rankOrder||rankOrderById(m.rankId));
      const badges=`${m.promoMajority?`<span class="badge badge-top badge-promote">تم الترقية</span>`:''}${m.featuredMajority?`<span class="badge badge-top badge-featured">مُميّز</span>`:''}`;
      col.innerHTML=`<div class="card p-3 fieldcard position-relative">
          ${badges}
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-bold">${m.name}</div>
              <div class="small"><span class="rank-chip ${rClass}">${m.rankName}</span></div>
              <div class="muted small mt-1">الفريق: ${m.teamName}</div>
              <div class="small mt-2">الحضور: <strong>${m.attendance.attended}</strong> / ${m.attendance.total} — الغياب: <strong>${Math.max((m.attendance.total-m.attendance.attended),0)}</strong></div>
              <div class="small muted mt-1">آخر تقييم: ${m.lastEval?(m.lastEval.pctAvg+'%'):'-'}</div>
            </div>
          </div>
          <div class="mt-3"><button class="btn btn-sm btn-primary" data-open="${m.memberId}">تعديل / تصويت</button></div>
        </div>`;
      grid.appendChild(col);
    });
  }

  // Open modal (same as قبل)
  document.addEventListener('click',(e)=>{ const id=e.target.getAttribute?.('data-open'); if(id) openMemberModal(id); });

  // ===== Modal helpers (مختصرة) =====
  let CURRENT_DETAIL=null;
  function ymNow(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
  function calcAttendPct(a,t){a=Number(a||0);t=Number(t||0);if(!t)return 0;return Math.max(0,Math.min(100,Math.round((a/t)*100)))}

  async function openMemberModal(memberId){
    CURRENT_DETAIL = await withLoader(()=>api('getMemberDetail',{token:STATE.token,memberId}), 'جارِ تحميل تفاصيل العضو…');
    const d=CURRENT_DETAIL; document.getElementById('mmTitle').textContent=d.member.name;
    const qs=d.questions?.length?d.questions:Array.from({length:10}).map((_,i)=>`سؤال ${i+1}`);
    const ev=d.lastEval, answers=ev?.answers||Array.from({length:10}).map(()=>({yes:false,pct:0}));
    let html=`<div class="row g-3">
        <div class="col-md-4"><label class="form-label">الاسم</label><input class="form-control" value="${d.member.name}" disabled></div>
        <div class="col-md-4"><label class="form-label">الفريق</label><input class="form-control" value="${d.member.teamName}" disabled></div>
        <div class="col-md-4"><label class="form-label">الرتبة</label><input class="form-control" value="${d.member.rankName}" disabled></div>
      </div><hr class="my-3"><div class="row g-3">`;
    qs.forEach((q,i)=>{const y=answers[i]?.yes?'checked':'';const pct=answers[i]?.pct??0;html+=`<div class="col-md-6"><div class="card p-3"><div class="d-flex justify-content-between align-items-center"><strong>${i+1}. ${q}</strong><div class="d-flex align-items-center gap-2"><div class="form-check"><input type="checkbox" class="form-check-input evYes" data-i="${i}" ${y}><label class="form-check-label">نعم</label></div><input type="number" class="form-control evPct" data-i="${i}" value="${pct}" min="0" max="100" style="width:90px" placeholder="%"></div></div></div></div>`;});
    html+=`</div><div class="row g-3 mt-3"><div class="col-md-6"><label class="form-label">Positive note</label><textarea id="mmPos" class="form-control" rows="2">${ev?.positiveNote||''}</textarea></div><div class="col-md-6"><label class="form-label">Negative note</label><textarea id="mmNeg" class="form-control" rows="2">${ev?.negativeNote||''}</textarea></div></div>`;
    if(STATE.user.role!=='ADMIN'){const la=d.lastAttendance||{period:ymNow(),attended:0,total:0};const pctNow=calcAttendPct(la.attended,la.total);html+=`<hr class="my-3"><h6>الحضور</h6><div class="row g-3"><div class="col-md-4"><label class="form-label">الفترة (YYYY-MM)</label><input id="mmPeriod" class="form-control" value="${la.period||ymNow()}" placeholder="YYYY-MM"></div><div class="col-md-4"><label class="form-label">حضر</label><input id="mmAtt" type="number" min="0" class="form-control" value="${la.attended||0}"></div><div class="col-md-4"><label class="form-label">من إجمالي</label><input id="mmTot" type="number" min="1" class="form-control" value="${la.total||0}"></div><div class="col-12"><div class="alert alert-light border mt-2">النسبة: <strong id="mmPct">${pctNow}%</strong></div></div></div>`}else{const la=d.lastAttendance;html+=`<hr class="my-3"><h6>الحضور</h6><div class="alert alert-light border">${la?`الفترة: <strong>${la.period}</strong> — حضر <strong>${la.attended}</strong> من <strong>${la.total}</strong> (غياب: <strong>${Math.max(la.total-la.attended,0)}</strong>) — النسبة: <strong>${calcAttendPct(la.attended,la.total)}%</strong>`:'لا توجد بيانات حضور بعد.'}</div>`}
    if(STATE.user.role==='ADMIN'){html+=`<hr class="my-3"><h6 class="mb-2">التصويت (ترقية/تميّز) — بواسطة القادة</h6><div class="table-responsive"><table class="table align-middle"><thead><tr><th>القائد</th><th>ترقية</th><th>تميّز</th></tr></thead><tbody>`;(d.leaders||[]).forEach(l=>{const lv=d.leaderVotes?.[l.leaderId]||{};const pYes=lv.PROMOTION==='YES'?'checked':'';const pNo=lv.PROMOTION==='NO'?'checked':'';const fYes=lv.FEATURED==='YES'?'checked':'';const fNo=lv.FEATURED==='NO'?'checked':'';html+=`<tr><td>${l.name}</td><td><div class="btn-group" role="group"><input type="radio" class="btn-check voteProm" name="prom-${l.leaderId}" id="prom-yes-${l.leaderId}" value="YES" ${pYes}><label class="btn btn-outline-success" for="prom-yes-${l.leaderId}">نعم</label><input type="radio" class="btn-check voteProm" name="prom-${l.leaderId}" id="prom-no-${l.leaderId}" value="NO" ${pNo}><label class="btn btn-outline-danger" for="prom-no-${l.leaderId}">لا</label></div></td><td><div class="btn-group" role="group"><input type="radio" class="btn-check voteFeat" name="feat-${l.leaderId}" id="feat-yes-${l.leaderId}" value="YES" ${fYes}><label class="btn btn-outline-success" for="feat-yes-${l.leaderId}">نعم</label><input type="radio" class="btn-check voteFeat" name="feat-${l.leaderId}" id="feat-no-${l.leaderId}" value="NO" ${fNo}><label class="btn btn-outline-danger" for="feat-no-${l.leaderId}">لا</label></div></td></tr>`});html+=`</tbody></table></div>`}
    document.getElementById('mmBody').innerHTML=html;
    document.getElementById('mmFooter').innerHTML=`<button id="btnSaveEval" class="btn btn-primary">حفظ التقييم${STATE.user.role!=='ADMIN'?' / الحضور':''}</button>${STATE.user.role==='ADMIN'?'<button id="btnSaveVotes" class="btn btn-outline-success">حفظ التصويتات</button>':''}`;
    new bootstrap.Modal(document.getElementById('memberModal')).show();
    if(STATE.user.role!=='ADMIN'){const attInp=document.getElementById('mmAtt'),totInp=document.getElementById('mmTot'),pctLbl=document.getElementById('mmPct');const onCh=()=>pctLbl.textContent=calcAttendPct(attInp.value,totInp.value)+'%';attInp.addEventListener('input',onCh);totInp.addEventListener('input',onCh)}
    document.getElementById('btnSaveEval').onclick=async()=>{const ans=Array.from(document.querySelectorAll('.evPct')).map(inp=>{const i=Number(inp.getAttribute('data-i'));const yes=document.querySelector(`.evYes[data-i="${i}"]`).checked;const pct=Number(inp.value||0);return{yes,pct}});const payload={token:STATE.token,memberId:d.member.memberId,answers:ans,positiveNote:document.getElementById('mmPos').value,negativeNote:document.getElementById('mmNeg').value};if(d.lastEval?.evaluationId){payload.evaluationId=d.lastEval.evaluationId;await withLoader(()=>api('updateEvaluation',payload),'جارِ حفظ التقييم…')}else{await withLoader(()=>api('saveEvaluation',payload),'جارِ حفظ التقييم…')}if(STATE.user.role!=='ADMIN'){let period=(document.getElementById('mmPeriod').value||'').trim();if(!period)period=ymNow();const attended=Number(document.getElementById('mmAtt').value||0),total=Number(document.getElementById('mmTot').value||0);if(total>0)await withLoader(()=>api('saveAttendance',{token:STATE.token,memberId:d.member.memberId,period,attended,total}),'جارِ حفظ الحضور…');await loadLeaderMembers()}alert('تم الحفظ')};
    const btnV=document.getElementById('btnSaveVotes'); if(btnV){btnV.onclick=async()=>{const leaders=(d.leaders||[]).map(l=>l.leaderId);await withLoader(async()=>{for(const lid of leaders){const prom=document.querySelector(`input[name="prom-${lid}"]:checked`)?.value;const feat=document.querySelector(`input[name="feat-${lid}"]:checked`)?.value;if(prom)await api('castVote',{token:STATE.token,memberId:d.member.memberId,voteType:'PROMOTION',vote:prom,voterLeaderId:lid});if(feat)await api('castVote',{token:STATE.token,memberId:d.member.memberId,voteType:'FEATURED',vote:feat,voterLeaderId:lid});}},'جارِ حفظ التصويتات…');await loadAdminMembers();await loadAdminStats();alert('تم حفظ التصويتات')};}
  }
</script>
</body>
</html>
