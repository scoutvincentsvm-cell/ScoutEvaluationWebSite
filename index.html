<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scout Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body{background:#F8FAFC}
    .navbar{background:#fff;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    .brand{color:#111827;font-weight:800;letter-spacing:.3px}
    .brand img{height:28px;width:auto;object-fit:contain}
    .card{border:0;box-shadow:0 8px 24px rgba(2,6,23,.06);border-radius:16px}
    .progress{height:10px;border-radius:10px}
    .app-loader{position:fixed;inset:0;background:rgba(255,255,255,.65);display:none;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(2px);font-weight:600}
    .fieldcard{transition:transform .15s ease,box-shadow .15s ease}
    .fieldcard:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(2,6,23,.10)}
    .badge-top{position:absolute;top:10px;inset-inline-end:10px;border-radius:999px;padding:.35rem .6rem}
    .badge-promote{background:#10B981;color:#fff;box-shadow:0 6px 14px rgba(16,185,129,.25)}
    .badge-featured{background:#22D3EE;color:#0c4a6e;box-shadow:0 6px 14px rgba(34,211,238,.25);inset-inline-end:116px}
    .rank-chip{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;font-weight:600}
    .rank-1{background:#9CA3AF;color:#fff}
    .rank-2{background:#F59E0B;color:#111827}
    .rank-3{background:#3B82F6;color:#fff}
    .muted{color:#6B7280}
    canvas{max-height:260px}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-4">
  <div class="container">
    <a class="navbar-brand brand d-flex align-items-center gap-2" href="#">
      <img id="navLogo" alt="Logo" style="display:none">
      <span>Scout Manager</span>
    </a>
    <div class="ms-auto d-flex align-items-center">
      <span class="me-3 text-muted" id="whoami"></span>
      <button class="btn btn-outline-danger btn-sm" id="btnLogout" style="display:none;">خروج</button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- Login -->
  <section id="viewLogin" class="row justify-content-center">
    <div class="col-md-5">
      <div class="card p-4 text-center">
        <img id="siteLogo" alt="Logo" style="height:84px;object-fit:contain;margin-bottom:12px;display:none">
        <h5 class="mb-3">تسجيل الدخول</h5>
        <form id="loginForm" autocomplete="on">
          <div class="mb-3 text-start">
            <label class="form-label">اسم المستخدم</label>
            <input id="inUser" name="username" type="text" class="form-control" autocomplete="username" required>
          </div>
          <div class="mb-3 text-start">
            <label class="form-label">كلمة السر</label>
            <input id="inPass" name="password" type="password" class="form-control" autocomplete="current-password" required>
          </div>
          <button id="btnLogin" type="submit" class="btn btn-primary w-100">دخول</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Leader View -->
  <section id="viewLeader" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">أعضاء الكشافة</h5>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="leadViewAll">
          <label class="form-check-label small" for="leadViewAll">عرض كل الفرق (قراءة فقط)</label>
        </div>
        <select id="leadTeam" class="form-select" style="width:auto;display:none"><option value="">كل الفرق</option></select>
        <select id="leadRank" class="form-select" style="width:auto"><option value="">كل الرتب</option></select>
        <input id="leadQ" class="form-control" placeholder="ابحث بالاسم…">
        <div class="form-check" title="تمت ترقيتهم">
          <input class="form-check-input" type="checkbox" id="leadPromoted">
          <label class="form-check-label small" for="leadPromoted">ترقية</label>
        </div>
        <div class="form-check" title="مميز">
          <input class="form-check-input" type="checkbox" id="leadFeatured">
          <label class="form-check-label small" for="leadFeatured">مُميّز</label>
        </div>
      </div>
    </div>
    <div id="leaderMembers" class="row g-3"></div>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="small text-muted" id="leaderRange"></div>
      <nav><ul class="pagination mb-0" id="leaderPagination"></ul></nav>
    </div>
  </section>

  <!-- Admin View -->
  <section id="viewAdmin" style="display:none;">
    <div class="row g-3 mb-4">
      <div class="col-lg-7">
        <div class="card p-3">
          <h6>توزيع الأعضاء حسب الفريق</h6>
          <canvas id="chPerTeam" height="220"></canvas>
          <div class="small text-muted mt-2" id="teamAvgNote"></div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card p-3 mb-3">
          <h6 class="mb-2">عدد الأشخاص في كل رتبة (الحالي)</h6>
          <ul id="listPerRank" class="list-group list-group-flush small"></ul>
        </div>
        <div class="card p-3">
          <h6 class="mb-2">بعد تطبيق الترقيات الحالية</h6>
          <ul id="listPerRankAfter" class="list-group list-group-flush small"></ul>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2 mb-3">
        <div class="col-auto"><select id="fltTeam" class="form-select"><option value="">كل الفرق</option></select></div>
        <div class="col-auto"><select id="fltRank" class="form-select"><option value="">كل الرتب</option></select></div>
        <div class="col"><input id="fltQ" class="form-control" placeholder="بحث بالاسم…"></div>
        <div class="col-auto d-flex align-items-center gap-2">
          <div class="form-check"><input class="form-check-input" type="checkbox" id="fltPromoted" checked><label class="form-check-label" for="fltPromoted">تمت ترقيتهم (أغلبية)</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="fltFeatured"><label class="form-check-label" for="fltFeatured">حاصلون على تميّز (أغلبية)</label></div>
        </div>
      </div>

      <div id="adminMembers" class="row g-3"></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="small text-muted" id="adminRange"></div>
        <nav><ul class="pagination mb-0" id="adminPagination"></ul></nav>
      </div>
    </div>
  </section>

</div>

<!-- Member Modal -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="mmTitle" class="modal-title">عضو</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><div id="mmBody"></div></div>
      <div class="modal-footer" id="mmFooter"></div>
    </div>
  </div>
</div>

<!-- Loader -->
<div id="appLoader" class="app-loader">
  <div class="spinner-border" role="status" aria-hidden="true"></div>
  <span class="ms-2" id="appLoaderMsg">جارِ التحميل…</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  // === CONFIG ===
  const API = "https://script.google.com/macros/s/AKfycbwgsymon0OLYi5U6Zs8zPLlp22LCZHrXDQYCc8d6hIFifUrh3aRHWEQW6yGB68B3woo/exec"; // EXEC URL
  const DEFAULT_LOGO_URL = "https://drive.google.com/uc?export=view&id=1w4IltFUCq27-ft-Z05grzv9i-i4tdG58";

  // Loader
  function showLoader(msg='جارِ التحميل…'){ appLoaderMsg.textContent=msg; appLoader.style.display='flex'; }
  function hideLoader(){ appLoader.style.display='none'; }
  async function withLoader(fn,msg){ showLoader(msg||'جارِ التحميل…'); try{ return await fn(); } finally{ hideLoader(); } }

  // Logo helpers
  function extractDriveId(url){
    if (!url) return null;
    const m1 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    const m2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    return (m1 && m1[1]) || (m2 && m2[1]) || null;
  }
  function resolveLogoSources(raw){
    if(!raw) return [DEFAULT_LOGO_URL];
    if(!/drive\.google/.test(raw) || /^data:image/.test(raw)) return [raw];
    const id = extractDriveId(raw);
    if(!id) return [raw];
    return [
      `https://lh3.googleusercontent.com/d/${id}=s600`,
      `https://drive.google.com/thumbnail?id=${id}&sz=w1000`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ];
  }
  function setImgWithFallback(imgEl, sources){
    if(!Array.isArray(sources)) sources=[sources];
    let i=0;
    const tryNext=()=>{
      if(i>=sources.length) return;
      const base=sources[i++]; const url=base+(base.includes('?')?'&':'?')+'t='+Date.now();
      imgEl.onload=()=>{imgEl.style.display='inline-block'; imgEl.onload=imgEl.onerror=null;};
      imgEl.onerror=tryNext; imgEl.src=url;
    }; tryNext();
  }

  // API
  async function api(path, payload={}){
    payload.path=path;
    const res=await fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(!data.ok) throw new Error(data.error||'API error');
    return data;
  }

  // State
  const STATE={token:null,user:null,ranks:[]}; let LOOKUPS={teams:[],ranks:[],logoUrl:''};

  // Stats cache
  const STATS_CACHE = { tick:null, data:null };
  const keyStats = 'SM_STATS_CACHE';
  function loadStatsCache(){
    try{ const raw=localStorage.getItem(keyStats); if(!raw) return;
      const obj=JSON.parse(raw); STATS_CACHE.tick=obj.tick||null; STATS_CACHE.data=obj.data||null;
    }catch(_){}
  }
  function saveStatsCache(){ try{ localStorage.setItem(keyStats, JSON.stringify({tick:STATS_CACHE.tick, data:STATS_CACHE.data})); }catch(_){} }

  // Admin cache & pagination
  const ADMIN_CACHE = { allReady:false, all:[], lastFiltered:[], lastFilters:null };
  const ADMIN_PAGER = { page:1, size:5 };

  // Leader mode + cache
  let LEADER_MODE_ALL=false;
  let LEADER_TEAM_ID=null;
  const LEADER_CACHE = { allReady:false, all:[], lastFiltered:[] };
  const LEADER_PAGER = { page:1, size:5 };

  // Session
  function saveSession(t,u){ localStorage.setItem('SM_TOKEN',t); localStorage.setItem('SM_USER',JSON.stringify(u)); }
  function loadSession(){ const t=localStorage.getItem('SM_TOKEN'),u=localStorage.getItem('SM_USER'); if(t&&u){ STATE.token=t; STATE.user=JSON.parse(u); return true; } return false; }
  function clearSession(){ localStorage.removeItem('SM_TOKEN'); localStorage.removeItem('SM_USER'); STATE.token=null; STATE.user=null; }
  function showView(id){ ['viewLogin','viewLeader','viewAdmin'].forEach(s=>document.getElementById(s).style.display='none'); document.getElementById(id).style.display=''; document.getElementById('btnLogout').style.display=(id==='viewLogin')?'none':''; }

  // Lookups
  async function loadLookups(){ LOOKUPS = await api('getLookups', {}); STATE.ranks = LOOKUPS.ranks||[]; return LOOKUPS; }
  function setLogos(url){
    const site=document.getElementById('siteLogo');
    const nav=document.getElementById('navLogo');
    const srcs=resolveLogoSources(url||DEFAULT_LOGO_URL);
    setImgWithFallback(nav, srcs); setImgWithFallback(site, srcs);
  }
  function rankOrderById(id){ const r=(LOOKUPS.ranks||[]).find(x=>x.id===id); return r? (r.order||0) : 0; }
  function rankClassFromOrder(o){ if(o>=3) return 'rank-3'; if(o===2) return 'rank-2'; return 'rank-1'; }
  function debounce(fn,wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
  function ymNow(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
  function calcAttendPct(a,t){a=Number(a||0);t=Number(t||0);if(!t)return 0;return Math.max(0,Math.min(100,Math.round((a/t)*100)))}

  // DOM refs
  const appLoader = document.getElementById('appLoader');
  const appLoaderMsg = document.getElementById('appLoaderMsg');

  document.addEventListener('DOMContentLoaded', async ()=>{
    loadStatsCache();
    try { const lk = await loadLookups(); setLogos(lk.logoUrl || DEFAULT_LOGO_URL); } catch(e) { setLogos(DEFAULT_LOGO_URL); }

    document.querySelector('#loginForm')?.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const username=document.querySelector('#inUser').value.trim();
      const password=document.querySelector('#inPass').value;
      try{
        const data = await withLoader(()=>api('login',{username,password}),'جارِ تسجيل الدخول…');
        STATE.token=data.token; STATE.user=data.user; saveSession(data.token,data.user);
        await initCommon();
        if (data.user.role==='ADMIN') initAdmin(); else initLeader();
      }catch(err){ alert(err.message); }
    });

    if (loadSession()) { await initCommon(); if (STATE.user.role==='ADMIN') initAdmin(); else initLeader(); }
    else { showView('viewLogin'); }
  });

  async function initCommon(){
    document.getElementById('whoami').textContent=`${STATE.user?.name||''} (${STATE.user?.role||''})`;
    const lk = await loadLookups(); setLogos(lk.logoUrl || DEFAULT_LOGO_URL);
    document.getElementById('btnLogout').onclick=()=>{ clearSession(); document.getElementById('whoami').textContent=''; showView('viewLogin'); };
  }

  // ===== Stats (Admin) with cache =====
  let CH_TEAM=null;
  async function ensureStatsFresh(force=false){
    try{
      const tickRes = await api('getChangeTick', {});
      const tick = tickRes.tick;
      if(!force && STATS_CACHE.data && STATS_CACHE.tick===tick){
        renderAdminStats(STATS_CACHE.data);
        return;
      }
      const s = await withLoader(()=>api('getStatsV2',{token:STATE.token}),'جارِ تحميل الإحصائيات…');
      STATS_CACHE.data = s; STATS_CACHE.tick = s.tick ?? tick;
      saveStatsCache();
      renderAdminStats(s);
    }catch(e){
      if(STATS_CACHE.data) renderAdminStats(STATS_CACHE.data);
    }
  }
  function renderAdminStats(s){
    const tLabels=Object.keys(s.perTeam).map(k=>s.teamMap[k]||k);
    const tData=Object.keys(s.perTeam).map(k=>s.perTeam[k]);
    if(CH_TEAM) CH_TEAM.destroy();
    CH_TEAM=new Chart(document.getElementById('chPerTeam'),{
      type:'bar',
      data:{labels:tLabels,datasets:[{label:'عدد الأعضاء',data:tData,borderRadius:8}]},
      options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>v,font:{weight:'bold'}}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}},
      plugins:[ChartDataLabels]
    });
    const L1=document.getElementById('listPerRank'); L1.innerHTML='';
    const L2=document.getElementById('listPerRankAfter'); L2.innerHTML='';
    Object.keys(s.perRank).forEach(k=>{const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between'; li.innerHTML=`<span>${s.rankMap[k]||k}</span><strong>${s.perRank[k]}</strong>`; L1.appendChild(li);});
    Object.keys(s.perRankAfter).forEach(k=>{const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between'; li.innerHTML=`<span>${s.rankMap[k]||k}</span><strong>${s.perRankAfter[k]}</strong>`; L2.appendChild(li);});
    const avg=Object.keys(s.attAvgTeam||{}).map(k=>`${s.teamMap[k]||k}: ${s.attAvgTeam[k]}%`).join(' • ');
    document.getElementById('teamAvgNote').textContent=avg?`متوسط الحضور: ${avg}`:'';
  }

  // ================= LEADER =================
  async function initLeader(){
    showView('viewLeader');

    // Fill ranks + teams
    const selR=document.getElementById('leadRank'); selR.innerHTML='<option value="">كل الرتب</option>';
    (LOOKUPS.ranks||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; selR.appendChild(o); });

    const selT=document.getElementById('leadTeam');
    if (selT){
      selT.innerHTML='<option value="">كل الفرق</option>';
      (LOOKUPS.teams||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; selT.appendChild(o); });
    }

    const deb=debounce(applyLeaderFilters,150);
    document.getElementById('leadRank').addEventListener('change',deb);
    document.getElementById('leadQ').addEventListener('input',deb);
    document.getElementById('leadPromoted').addEventListener('change',deb);
    document.getElementById('leadFeatured').addEventListener('change',deb);
    if (selT) selT.addEventListener('change',deb);

    // Toggle "view all"
    const ch=document.getElementById('leadViewAll');
    if (ch){
      ch.addEventListener('change', async ()=>{
        LEADER_MODE_ALL = !!ch.checked;
        document.getElementById('leadTeam').style.display = LEADER_MODE_ALL ? '' : 'none';
        await loadLeaderData();
      });
    }

    await loadLeaderData();
  }

  async function loadLeaderData(){
    if(!LEADER_MODE_ALL){
      // أعضاء فريقي فقط
      const res=await withLoader(()=>api('listMembers',{token:STATE.token,filters:{}}),'جارِ تحميل أعضاء فريقي…');
      LEADER_CACHE.all = res.members||[];
      // استنتاج teamId للقائد (الأكثر تكرارًا)
      const ids = (LEADER_CACHE.all||[]).map(m=>m.teamId).filter(Boolean);
      LEADER_TEAM_ID = ids.length? ids.sort((a,b)=>ids.filter(x=>x===a).length - ids.filter(x=>x===b).length).pop(): null;
    } else {
      // كل الأعضاء (قراءة فقط لما هو خارج فريقي) — مسار جديد
      const res=await withLoader(()=>api('getMembersAll',{token:STATE.token,filters:{}}),'جارِ تحميل كل الأعضاء…');
      LEADER_CACHE.all = res.members||[];
      if(!LEADER_TEAM_ID){
        const mine = (LEADER_CACHE.all||[]).find(m=> (m.leaderName && STATE.user?.name && m.leaderName===STATE.user.name));
        if(mine) LEADER_TEAM_ID = mine.teamId||null;
      }
    }
    LEADER_CACHE.allReady = true;
    LEADER_PAGER.page = 1;
    applyLeaderFilters();
  }

  function leaderCurrentFilters(){
    return {
      teamId: (document.getElementById('leadTeam')?.value||''),
      rankId: document.getElementById('leadRank').value||'',
      q: (document.getElementById('leadQ').value||'').toLowerCase(),
      promoted: document.getElementById('leadPromoted').checked,
      featured: document.getElementById('leadFeatured').checked
    };
  }

  function applyLeaderFilters(){
    const f=leaderCurrentFilters();
    let list=LEADER_CACHE.all.slice();
    if (LEADER_MODE_ALL && f.teamId) list = list.filter(m=>m.teamId===f.teamId);
    if (f.rankId) list = list.filter(m=>m.rankId===f.rankId);
    if (f.promoted) list = list.filter(m=>m.promoMajority===true);
    if (f.featured) list = list.filter(m=>m.featuredMajority===true);
    if (f.q) list = list.filter(m=>String(m.name||'').toLowerCase().includes(f.q));
    LEADER_CACHE.lastFiltered = list;
    LEADER_PAGER.page = 1;
    applyLeaderPaginationAndRender();
  }

  function leaderTotalPages(){
    const total=(LEADER_CACHE.lastFiltered||[]).length;
    return Math.max(1, Math.ceil(total/LEADER_PAGER.size));
  }

  function applyLeaderPaginationAndRender(){
    const all=LEADER_CACHE.lastFiltered||[];
    const total=all.length; const pages=leaderTotalPages();
    if(LEADER_PAGER.page>pages) LEADER_PAGER.page=pages;
    const start=(LEADER_PAGER.page-1)*LEADER_PAGER.size;
    const end=Math.min(start+LEADER_PAGER.size,total);
    renderLeaderMembers(all.slice(start,end),{total,start,end,pages,current:LEADER_PAGER.page});
  }

  function renderLeaderMembers(list, meta){
    const wrap=document.getElementById('leaderMembers'); wrap.innerHTML='';
    list.forEach(m=>{
      const col=document.createElement('div'); col.className='col-md-4';
      const rClass=rankClassFromOrder(m.rankOrder||rankOrderById(m.rankId));
      const canEdit = (!LEADER_MODE_ALL) || (m.teamId && m.teamId===LEADER_TEAM_ID);
      const badges = `${m.promoMajority?'<span class="badge badge-top badge-promote">تم الترقية</span>':''}${m.featuredMajority?'<span class="badge badge-top badge-featured">مُميّز</span>':''}`;
      const btnLabel = canEdit? 'تقييم / حضور' : 'عرض التفاصيل';
      col.innerHTML=`<div class="card p-3 fieldcard position-relative" data-member="${m.memberId}">
          ${badges}
          <div class="fw-bold">${m.name}</div>
          <div class="small"><span class="rank-chip ${rClass}">${m.rankName}</span></div>
          <div class="text-muted small mt-1">الفريق: ${m.teamName}</div>
          <div class="small mt-2">الحضور: <strong>${m.attendance?.attended||0}</strong> من <strong>${m.attendance?.total||0}</strong> (<strong>${m.attendance?.percent||0}%</strong>)</div>
          <div class="mt-2 small text-muted">آخر تقييم: ${m.lastEval?.pctAvg?(m.lastEval.pctAvg+'%'):'-'}</div>
          <div class="mt-3"><button class="btn btn-sm ${canEdit?'btn-primary':'btn-outline-secondary'}" data-open="${m.memberId}">${btnLabel}</button></div>
        </div>`;
      wrap.appendChild(col);
    });
    // pagination
    const range=document.getElementById('leaderRange');
    const pag=document.getElementById('leaderPagination');
    if(!meta || meta.total===0){ range.textContent=''; pag.innerHTML=''; return; }
    range.textContent=`عرض ${meta.start+1}–${meta.end} من ${meta.total}`;
    const pages=meta.pages, current=meta.current;
    const liPrev=`<li class="page-item ${current===1?'disabled':''}"><a class="page-link" href="javascript:void(0)" data-lpage="prev">السابق</a></li>`;
    const windowSize=5;
    let s=Math.max(1,current-Math.floor(windowSize/2));
    let e=Math.min(pages,s+windowSize-1); s=Math.max(1,e-windowSize+1);
    let nums=''; for(let p=s;p<=e;p++) nums += `<li class="page-item ${p===current?'active':''}"><a class="page-link" href="javascript:void(0)" data-lpage="${p}">${p}</a></li>`;
    const liNext=`<li class="page-item ${current===pages?'disabled':''}"><a class="page-link" href="javascript:void(0)" data-lpage="next">التالي</a></li>`;
    pag.innerHTML=liPrev+nums+liNext;
  }

  // Pagination click
  document.getElementById('leaderPagination').addEventListener('click', (e)=>{
    const btn=e.target.closest('[data-lpage]'); if(!btn) return;
    const to=btn.getAttribute('data-lpage'); const pages=leaderTotalPages();
    if(to==='prev') LEADER_PAGER.page = Math.max(1, LEADER_PAGER.page-1);
    else if(to==='next') LEADER_PAGER.page = Math.min(pages, LEADER_PAGER.page+1);
    else LEADER_PAGER.page = Math.max(1, Math.min(pages, parseInt(to)));
    applyLeaderPaginationAndRender();
  });

  // Open modal (admin & leader)
  document.addEventListener('click',(e)=>{ const id=e.target.getAttribute?.('data-open'); if(id) openMemberModal(id); });

  // ===== Modal =====
  let CURRENT_DETAIL=null;

  async function openMemberModal(memberId){
    let d=null;
    let readOnly=false;

    // إن كان إدمن -> تفاصيل كاملة
    if(STATE.user.role==='ADMIN'){
      d = await withLoader(()=>api('getMemberDetail',{token:STATE.token,memberId}), 'جارِ تحميل تفاصيل العضو…');
    }else{
      // قائد:
      // لو في وضع "عرض كل الفرق" أو العضو ليس من نفس فريق القائد -> اقرأ Read-Only
      // وإلا -> تفاصيل كاملة لإمكانية التعديل
      const item = (LEADER_CACHE.all||[]).find(x=>x.memberId===memberId);
      const sameTeam = !!(item && LEADER_TEAM_ID && item.teamId===LEADER_TEAM_ID);
      if(!sameTeam){
        d = await withLoader(()=>api('getMemberDetailRO',{token:STATE.token,memberId}), 'جارِ تحميل التفاصيل (قراءة فقط)…');
        readOnly=true;
      }else{
        d = await withLoader(()=>api('getMemberDetail',{token:STATE.token,memberId}), 'جارِ تحميل تفاصيل العضو…');
      }
    }

    CURRENT_DETAIL = d;
    document.getElementById('mmTitle').textContent=d.member.name;
    const qs=d.questions?.length?d.questions:Array.from({length:10}).map((_,i)=>`سؤال ${i+1}`);
    const ev=d.lastEval, answers=ev?.answers||Array.from({length:10}).map(()=>({yes:false,pct:0}));

    let html=`<div class="row g-3">
        <div class="col-md-4"><label class="form-label">الاسم</label><input class="form-control" value="${d.member.name}" disabled></div>
        <div class="col-md-4"><label class="form-label">الفريق</label><input class="form-control" value="${d.member.teamName}" disabled></div>
        <div class="col-md-4"><label class="form-label">الرتبة</label><input class="form-control" value="${d.member.rankName}" disabled></div>
      </div><hr class="my-3"><div class="row g-3">`;

    qs.forEach((q,i)=>{
      const y=answers[i]?.yes?'checked':''; const pct=answers[i]?.pct??0;
      html+=`<div class="col-md-6"><div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <strong>${i+1}. ${q}</strong>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check">
              <input type="checkbox" class="form-check-input evYes" data-i="${i}" ${y} ${readOnly?'disabled':''}>
              <label class="form-check-label">نعم</label>
            </div>
            <input type="number" class="form-control evPct" data-i="${i}" value="${pct}" min="0" max="100" style="width:90px" placeholder="%" ${readOnly?'disabled':''}>
          </div>
        </div>
      </div></div>`;
    });

    html+=`</div>
      <div class="row g-3 mt-3">
        <div class="col-md-6"><label class="form-label">Positive note</label><textarea id="mmPos" class="form-control" rows="2" ${readOnly?'disabled':''}>${ev?.positiveNote||''}</textarea></div>
        <div class="col-md-6"><label class="form-label">Negative note</label><textarea id="mmNeg" class="form-control" rows="2" ${readOnly?'disabled':''}>${ev?.negativeNote||''}</textarea></div>
      </div>`;

    if(STATE.user.role!=='ADMIN' && !readOnly){
      const la=d.lastAttendance||{period:ymNow(),attended:0,total:0};
      const pctNow=calcAttendPct(la.attended,la.total);
      html+=`<hr class="my-3"><h6>الحضور</h6>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">الفترة (YYYY-MM)</label><input id="mmPeriod" class="form-control" value="${la.period||ymNow()}" placeholder="YYYY-MM"></div>
          <div class="col-md-4"><label class="form-label">حضر</label><input id="mmAtt" type="number" min="0" class="form-control" value="${la.attended||0}"></div>
          <div class="col-md-4"><label class="form-label">من إجمالي</label><input id="mmTot" type="number" min="1" class="form-control" value="${la.total||0}"></div>
          <div class="col-12"><div class="alert alert-light border mt-2">النسبة: <strong id="mmPct">${pctNow}%</strong></div></div>
        </div>`;
    } else {
      const la=d.lastAttendance;
      html+=`<hr class="my-3"><h6>الحضور</h6>
        <div class="alert alert-light border">
          ${la?`الفترة: <strong>${la.period}</strong> — حضر <strong>${la.attended}</strong> من <strong>${la.total}</strong> (غياب: <strong>${Math.max(la.total-la.attended,0)}</strong>) — النسبة: <strong>${calcAttendPct(la.attended,la.total)}%</strong>`:'لا توجد بيانات حضور بعد.'}
        </div>`;
    }

    // تصويتات القادة: الإدمن يحرر، القائد يشاهد فقط
    html+=`<hr class="my-3"><h6 class="mb-2">التصويت (ترقية/تميّز) — بواسطة القادة</h6>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead><tr><th>القائد</th><th>ترقية</th><th>تميّز</th></tr></thead>
          <tbody>`;

    (d.leaders||[]).forEach(l=>{
      const lv=d.leaderVotes?.[l.leaderId]||{};
      const pYes=lv.PROMOTION==='YES'?'checked':''; const pNo=lv.PROMOTION==='NO'?'checked':'';
      const fYes=lv.FEATURED==='YES'?'checked':'';   const fNo=lv.FEATURED==='NO'?'checked':'';
      if(STATE.user.role==='ADMIN'){
        html+=`<tr>
          <td>${l.name}</td>
          <td>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check voteProm" name="prom-${l.leaderId}" id="prom-yes-${l.leaderId}" value="YES" ${pYes}>
              <label class="btn btn-outline-success" for="prom-yes-${l.leaderId}">نعم</label>
              <input type="radio" class="btn-check" name="prom-${l.leaderId}" id="prom-no-${l.leaderId}" value="NO" ${pNo}>
              <label class="btn btn-outline-danger" for="prom-no-${l.leaderId}">لا</label>
            </div>
          </td>
          <td>
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check voteFeat" name="feat-${l.leaderId}" id="feat-yes-${l.leaderId}" value="YES" ${fYes}>
              <label class="btn btn-outline-success" for="feat-yes-${l.leaderId}">نعم</label>
              <input type="radio" class="btn-check" name="feat-${l.leaderId}" id="feat-no-${l.leaderId}" value="NO" ${fNo}>
              <label class="btn btn-outline-danger" for="feat-no-${l.leaderId}">لا</label>
            </div>
          </td>
        </tr>`;
      }else{
        // قائد: عرض فقط
        html+=`<tr>
          <td>${l.name}</td>
          <td>
            <span class="badge ${pYes?'bg-success':'bg-outline-secondary'}">${pYes?'YES':(pNo?'NO':'-')}</span>
          </td>
          <td>
            <span class="badge ${fYes?'bg-success':'bg-outline-secondary'}">${fYes?'YES':(fNo?'NO':'-')}</span>
          </td>
        </tr>`;
      }
    });

    html+=`</tbody></table></div>`;

    // صلاحيات التعديل
    let canEdit=false;
    if(STATE.user.role==='ADMIN'){
      canEdit=true;
    }else if(!readOnly){
      // نفس فريق القائد
      canEdit=true;
    }

    document.getElementById('mmBody').innerHTML=html;
    document.getElementById('mmFooter').innerHTML= canEdit ? `<button id="btnSaveAll" class="btn btn-primary">حفظ</button>` : `<span class='text-muted small'>عرض فقط — يمكنك تعديل أعضاء فريقك فقط</span>`;

    new bootstrap.Modal(document.getElementById('memberModal')).show();

    if(STATE.user.role!=='ADMIN' && !readOnly){
      const attInp=document.getElementById('mmAtt'),
            totInp=document.getElementById('mmTot'),
            pctLbl=document.getElementById('mmPct');
      if(attInp && totInp && pctLbl){
        const onCh=()=>pctLbl.textContent=calcAttendPct(attInp.value,totInp.value)+'%';
        attInp.addEventListener('input',onCh);
        totInp.addEventListener('input',onCh);
      }
    }

    const saveBtn=document.getElementById('btnSaveAll');
    if(saveBtn){
      saveBtn.onclick=async()=>{
        const ans=Array.from(document.querySelectorAll('.evPct')).map(inp=>{
          const i=Number(inp.getAttribute('data-i'));
          const yes=document.querySelector(`.evYes[data-i="${i}"]`)?.checked||false;
          const pct=Number(inp.value||0);
          return{yes,pct};
        });

        if(STATE.user.role==='ADMIN'){
          // Votes
          const votes=[];
          (d.leaders||[]).forEach(l=>{
            const prom=document.querySelector(`input[name="prom-${l.leaderId}"]:checked`)?.value||null;
            const feat=document.querySelector(`input[name="feat-${l.leaderId}"]:checked`)?.value||null;
            votes.push({leaderId:l.leaderId,promotion:prom,featured:feat});
          });

          const res = await withLoader(()=>api('adminSaveBundle',{
            token:STATE.token,
            memberId:d.member.memberId,
            answers:ans,
            positiveNote:document.getElementById('mmPos').value,
            negativeNote:document.getElementById('mmNeg').value,
            votes:votes
          }),'جارِ الحفظ…');

          await ensureStatsFresh(false);
          alert('تم الحفظ');
        } else {
          // Leader: evaluation + attendance مع شرط التحديث من نفس القائد فقط
          const payload = {
            token: STATE.token,
            memberId: d.member.memberId,
            answers: ans,
            positiveNote: document.getElementById('mmPos').value,
            negativeNote: document.getElementById('mmNeg').value
          };

          const canUpdateMyEval = !!(d.lastEval?.evaluationId && d.lastEval.leaderId === STATE.user.leaderId);

          if (canUpdateMyEval) {
            payload.evaluationId = d.lastEval.evaluationId;
            await withLoader(() => api('updateEvaluation', payload), 'جارِ حفظ التقييم…');
          } else {
            await withLoader(() => api('saveEvaluation', payload), 'جارِ حفظ التقييم…');
          }

          let period=(document.getElementById('mmPeriod')?.value||'').trim(); if(!period)period=ymNow();
          const attended=Number(document.getElementById('mmAtt')?.value||0),
                total=Number(document.getElementById('mmTot')?.value||0);
          if(total>0){
            await withLoader(()=>api('saveAttendance',{
              token:STATE.token,memberId:d.member.memberId,period,attended,total
            }),'جارِ حفظ الحضور…');
          }

          // تحديث بسيط محليًا
          LEADER_CACHE.all = LEADER_CACHE.all.map(m=>{
            if(m.memberId===d.member.memberId){
              m.lastEval = { pctAvg: Math.round(ans.reduce((a,x)=>a+Number(x.pct||0),0)/10) };
              if(total>0) m.attendance = { attended, total, percent: calcAttendPct(attended,total) };
            }
            return m;
          });
          applyLeaderFilters();
          alert('تم الحفظ');
        }
      };
    }
  }

  // ================= ADMIN =================
  async function initAdmin(){
    showView('viewAdmin');
    const selT=document.getElementById('fltTeam'), selR=document.getElementById('fltRank');
    selT.innerHTML='<option value="">كل الفرق</option>'; selR.innerHTML='<option value="">كل الرتب</option>';
    (LOOKUPS.teams||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; selT.appendChild(o); });
    (LOOKUPS.ranks||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; selR.appendChild(o); });

    document.getElementById('fltPromoted').checked = true;

    const deb=debounce(onAdminFiltersChanged,150);
    selT.addEventListener('change',deb); selR.addEventListener('change',deb);
    document.getElementById('fltQ').addEventListener('input',deb);
    document.getElementById('fltPromoted').addEventListener('change',deb);
    document.getElementById('fltFeatured').addEventListener('change',deb);

    document.getElementById('adminPagination').addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-page]'); if(!btn) return;
      const to = btn.getAttribute('data-page'); const pages = totalPages();
      if(to==='prev') ADMIN_PAGER.page = Math.max(1, ADMIN_PAGER.page-1);
      else if(to==='next') ADMIN_PAGER.page = Math.max(1, Math.min(pages, ADMIN_PAGER.page+1));
      else ADMIN_PAGER.page = Math.max(1, Math.min(pages, parseInt(to)));
      applyPaginationAndRender();
    });

    await ensureStatsFresh(false);
    await loadAdminMembers();

    // Prefetch all
    (async ()=>{
      try{
        const resAll = await api('getMembersAdmin',{token:STATE.token,filters:{}});
        ADMIN_CACHE.all = resAll.members||[];
        ADMIN_CACHE.allReady = true;
      }catch(_){}
    })();
  }

  function currentAdminFilters(){
    return {
      teamId:document.getElementById('fltTeam').value||'',
      rankId:document.getElementById('fltRank').value||'',
      q:(document.getElementById('fltQ').value||'').toLowerCase(),
      promoted:document.getElementById('fltPromoted').checked,
      featured:document.getElementById('fltFeatured').checked
    };
  }

  function onAdminFiltersChanged(){
    const f=currentAdminFilters();
    ADMIN_PAGER.page = 1;
    if(ADMIN_CACHE.allReady){
      const filtered = filterLocal(ADMIN_CACHE.all, f);
      ADMIN_CACHE.lastFiltered = filtered; ADMIN_CACHE.lastFilters = f;
      applyPaginationAndRender();
    }else{
      loadAdminMembers();
    }
  }

  function filterLocal(list, f){
    return (list||[]).filter(m=>{
      if(f.teamId && m.teamId!==f.teamId) return false;
      if(f.rankId && m.rankId!==f.rankId) return false;
      if(f.q && !String(m.name||'').toLowerCase().includes(f.q)) return false;
      if(f.promoted && !m.promoMajority) return false;
      if(f.featured && !m.featuredMajority) return false;
      return true;
    });
  }

  async function loadAdminMembers(){
    const f=currentAdminFilters();
    ADMIN_PAGER.page = 1;
    const filters={
      teamId:f.teamId||null, rankId:f.rankId||null, q:f.q||null,
      promoted:f.promoted?'true':null, featured:f.featured?'true':null
    };
    const res=await withLoader(()=>api('getMembersAdmin',{token:STATE.token,filters}),'جارِ تحميل الأعضاء…');
    ADMIN_CACHE.lastFiltered = res.members||[];
    ADMIN_CACHE.lastFilters = f;
    applyPaginationAndRender();
  }

  function totalPages(){
    const total = (ADMIN_CACHE.lastFiltered||[]).length;
    return Math.max(1, Math.ceil(total / ADMIN_PAGER.size));
  }

  function applyPaginationAndRender(){
    const all = ADMIN_CACHE.lastFiltered||[];
    const total = all.length;
    const pages = totalPages();
    if(ADMIN_PAGER.page > pages) ADMIN_PAGER.page = pages;
    const start = (ADMIN_PAGER.page - 1) * ADMIN_PAGER.size;
    const end = Math.min(start + ADMIN_PAGER.size, total);
    renderAdminMembers(all.slice(start, end), {total,start,end,pages,current:ADMIN_PAGER.page});
  }

  function renderAdminMembers(slice, meta){
    const grid=document.getElementById('adminMembers'); grid.innerHTML='';
    if(!slice.length){
      grid.innerHTML = `<div class="text-center text-muted py-4">لا توجد نتائج مطابقة</div>`;
    } else {
      slice.forEach(m=>{
        const col=document.createElement('div'); col.className='col-md-4';
        const rClass=rankClassFromOrder(m.rankOrder||rankOrderById(m.rankId));
        const badges=`${m.promoMajority?`<span class="badge badge-top badge-promote">تم الترقية</span>`:''}${m.featuredMajority?`<span class="badge badge-top badge-featured">مُميّز</span>`:''}`;
        col.innerHTML=`<div class="card p-3 fieldcard position-relative" data-member="${m.memberId}">
            ${badges}
            <div class="fw-bold">${m.name}</div>
            <div class="small"><span class="rank-chip ${rClass}">${m.rankName}</span></div>
            <div class="muted small mt-1">الفريق: ${m.teamName}</div>
            <div class="small mt-2">الحضور: <strong>${m.attendance.attended}</strong> / ${m.attendance.total} — الغياب: <strong>${Math.max((m.attendance.total-m.attendance.attended),0)}</strong></div>
            <div class="small muted mt-1">آخر تقييم: ${m.lastEval?(m.lastEval.pctAvg+'%'):'-'}</div>
            <div class="mt-3"><button class="btn btn-sm btn-primary" data-open="${m.memberId}">تعديل / تصويت</button></div>
          </div>`;
        grid.appendChild(col);
      });
    }
    renderAdminPagination(meta);
  }

  function renderAdminPagination(meta){
    const range = document.getElementById('adminRange');
    const pag = document.getElementById('adminPagination');
    const total = meta.total||0;
    if(total===0){ range.textContent=''; pag.innerHTML=''; return; }
    range.textContent = `عرض ${meta.start+1}–${meta.end} من ${total}`;
    const pages = meta.pages, current = meta.current;
    const liPrev = `<li class="page-item ${current===1?'disabled':''}"><a class="page-link" href="javascript:void(0)" data-page="prev">السابق</a></li>`;
    const windowSize = 5;
    let start = Math.max(1, current - Math.floor(windowSize/2));
    let end = Math.min(pages, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);
    let nums = '';
    for(let p=start; p<=end; p++){
      nums += `<li class="page-item ${p===current?'active':''}"><a class="page-link" href="javascript:void(0)" data-page="${p}">${p}</a></li>`;
    }
    const liNext = `<li class="page-item ${current===pages?'disabled':''}"><a class="page-link" href="javascript:void(0)" data-page="next">التالي</a></li>`;
    pag.innerHTML = liPrev + nums + liNext;
  }
</script>
</body>
</html>
